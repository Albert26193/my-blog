---
author: Albert
category: CS-基础
date: 2024-03-05
date created: 2023-05-09
date updated: 2024-02-10 10:06
description: 计算机网络常识
tags:
  - Blog
  - network
  - interview
title: 计算机网络-详解HTTPS
---

# 计算机网络-详解HTTPS

> [How does HTTPS work? (Episode 6) - by Alex Xu](https://blog.bytebytego.com/p/how-does-https-work-episode-6)

## 1. HTTPS 工作流程

![image.png|475](https://img-20221128.oss-cn-shanghai.aliyuncs.com/img-2023-05/20230915144932.png)

- 整体而言可以分成4个阶段：
  1. TCP握手
  2. 证书检查
  3. 秘钥交换
  4. 数据传输

### 1.1 前置概念

- `HTTPS` 的传输使用了对称加密和非对称加密
- 其中， *非对称加密*是服务于*对称加密*的。因为对称加密过程中，加密、解密的速度相对快，所以对于体积较大的通信数据，考虑使用*对称加密*。但是对称加密的秘钥的分发和管理比较繁琐，因此，需要用**非对称加密来传输对称加密需要用的的秘钥。**

---

- 对称加密
  - 常见算法：DES、AES
  - 加密解密使用同一个秘钥
  - 优势：速度快、计算量小、适合比较大的数据
  - 劣势：
    - 通信双方需要使用同一个秘钥，且秘钥无法被第三方得知。秘钥的数量增长很快。
    - 如果通信环境本身是不安全的，那么在传输过程中可能泄露秘钥，存在安全隐患。

---

- 非对称加密
  - 常见算法：RSA、ECC
  - 交互过程中使用一对秘钥，私钥用来加密解密，公钥在网络当中传输。
  - 优势：安全性好
  - 劣势：效率低，加密解密的计算都需要相对较长的时间。

![image.png|475](https://img-20221128.oss-cn-shanghai.aliyuncs.com/img-2023-05/20230915153340.png)

### 1.2 具体流程

![image.png|450](https://img-20221128.oss-cn-shanghai.aliyuncs.com/img-2023-05/20240305141435.png)

这张图片展示的是一个TLS（传输层安全协议）使用RSA密钥交换的握手过程的流程图。TLS协议用于在客户端和服务器之间提供一个安全的通信渠道。这个流程图使用了不同的颜色和块来区分不同的步骤，其中包括：

1. **ClientHello** (蓝色块): 客户端向服务器发送一个ClientHello消息，表明它希望开始TLS通信。这个消息包括：
   - TLS版本号
   - 客户端生成的随机数（Client Random）
   - 客户端支持的密码套件列表
2. **ServerHello** (绿色块): 服务器收到ClientHello后，回复一个ServerHello消息，内容包括：
   - 服务器选择的TLS版本号
   - 服务器生成的随机数（Server Random）
   - 服务器选择的密码套件，这里指定了ECDHE_RSA，表示椭圆曲线迪菲-赫尔曼密钥交换和RSA签名
3. **Certificate** (绿色块): 服务器发送它的证书给客户端，证书中包含了服务器的公钥。
4. **ServerHelloDone** (绿色块): 服务器告诉客户端它已经完成了Hello消息的发送。
5. **ClientKeyExchange** (蓝色块): 客户端回复一个ClientKeyExchange消息，发送用服务器公钥加密的预主密钥。
6. **ChangeCipherSpec** (蓝色和绿色块): 客户端和服务器都发送ChangeCipherSpec消息，告知对方接下来将使用协商的密码套件和密钥来加密消息。
7. **Finished** (蓝色和绿色块): 握手完成后，客户端和服务器交换Finished消息，验证握手过程。
8. **Application Data** (棕色块): 握手过程完成后，客户端和服务器开始安全地交换应用数据。

#### 1.2.1 TCP握手

- 与普通TCP连接建立当中的三次握手一样

#### 1.2.2 证书检查

- 客户端发起请求( `client hello` )，需要声明自己支持的加密算法列表。同时，附带了一个 `client random`。（用来对抗重放攻击？）
- 服务端对其进行响应(`server hello`)，将 `CA`证书（包括公钥发送给客户端）。此过程当中，服务端会附带一个 `server random` （用来对抗重放攻击？）

---

- 在服务端，想要建立 `HTTPS` 连接，首先需要申请到特定机构颁发的 `CA` 证书。`CA` 证书的底层原理是数字签名技术，用来确保完整性和真实性。
- 服务端发送给客户端的 `CA` 证书，本质上是对于自己身份的**一种证明**。
- 客户端拿到了服务端的 `CA` 证书，会进行校验，包括颁发结构、有效期、数字签名、是否被吊销、和当前域名相关的主题等等。

#### 1.2.3 秘钥交换

- 客户端拿到了服务端的 `CA` 证书包含的公钥之后，生成预主秘钥(`pre-master secret`)，这个预主秘钥是未来**对称加密所需秘钥**的组成部分。
- 客户端会利用服务端的公钥加密 “预主秘钥”，然后将其发送会服务器。
- 服务器收到了 “预主秘钥”之后，利用服务端自己保存的私钥进行解密，双方现在的信息已经一致了：
  - `client random`（在 `client hello` 阶段产生）
  - `server random`（在 `server hello` 阶段产生）
  - `pre-master-secret`（通过客户端产生，由服务端公钥进行保护）
- 利用上面的三个信息，可以生成真正的加密秘钥 `session key` 了，这个 `session key` 就是双方进行对称加密的秘钥。

#### 1.2.4 数据传输

- 双方利用对称加密的秘钥进行数据传输，确保信息的完整性、机密性、安全性。

![image.png](https://img-20221128.oss-cn-shanghai.aliyuncs.com/img-2023-05/20230915160501.png)

---

- 以上过程的 `ai` 总结如下：

> [!Ai]
> HTTPS的加密过程涉及到一个名为SSL/TLS握手的过程，该过程的目的是在客户端和服务器之间建立一个安全的连接。以下是这个过程的简化版步骤：
>
> 1. **客户端向服务器发送“Client hello”消息**：这个消息中包含了客户端支持的SSL/TLS版本，可用的加密算法（称为“密码套件”），以及一个客户端生成的随机数（Client Random）。
> 2. **服务器向客户端发送“Server hello”消息**：服务器在客户端提供的密码套件中选择一套它也支持的算法，并生成它自己的一个随机数（Server Random）。服务器还会将它的CA证书（包含服务器的公钥和一些身份信息）发送给客户端。
> 3. **客户端验证服务器证书**：客户端会验证服务器的证书是否由它信任的CA签发，证书是否在有效期内，以及证书的主题是否匹配服务器的地址。证书验证失败的话，通常会在浏览器中显示一个警告。
> 4. **客户端生成预主秘钥并加密**：如果证书验证成功，客户端会生成一个新的随机数，这个随机数被称为“预主密钥”（Pre-Master Secret）。客户端使用服务器的公钥对这个预主密钥进行加密，然后将其发送给服务器。
> 5. **服务器解密预主秘钥**：服务器使用它的私钥解密客户端发送过来的信息，得到预主密钥。
> 6. **生成会话密钥**：现在，客户端和服务器都有了相同的预主密钥，以及对方的随机数。他们会使用这些信息来生成会话密钥（Session Key），用于接下来的通信过程中对数据进行加密和解密。
> 7. **开始加密通信**：客户端和服务器现在都有了会话密钥，他们就可以开始安全的加密通信了。他们会使用会话密钥来对传输的数据进行加密，只有拥有相同会话密钥的一方才能解密这些数据。

## 2. HTTPS 如何应对多种攻击

### 2.1 消息窃听

- 在 `HTTPS` 的通信过程当中，会话内容经过了对称加密，且双方的会话密钥在握手阶段已经通过非对称加密进行了交换，因此，窃听内容非常困难。

### 2.2 消息篡改

- 首先，`CA` 证书在握手阶段就得到了交换，并且，双方通信阶段经过对称加密，攻击者很难获悉明文内容。
- 其次，`SSL` 协议提供了 `MAC` 消息完整性校验：在发送阶段，发送者会根据散列函数计算出消息的哈希值，*然后将哈希值和散列函数方法*一并发送到接收方，接受方接收消息之后，会根据散列函数重新计算哈希值，确保二者内容一致。
- `SSL` 协议还提供了序列号和时间戳，用来防止篡改后的消息重新发送回数据流中。

### 2.3 中间人攻击

- 即使中间人攻击能够顺利获取到中间传输的信息，也是经过加密的，无法获悉明文
- 中间人的身份需要通过 `CA` 证书进行核查，如果 `CA` 证书不受信任（或者和 `DNS` 信息不匹配，那么也会被发现）
- 消息完整性会得到 `MAC` 校验的保证，很难篡改消息。

### 2.4 重放攻击

- 在握手阶段，客户端和服务端都会发送随机数到对方，这个随机数用以后续的加密密钥生成，重放攻击者很难获取到对应的随机数，也就无法重放攻击。
- 在通信阶段，`SSL` 提供了序列号机制，按照序列号规则过滤不合法的消息，那么也可以使得重放攻击失效。
